<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Melbourne LGAs — UHI, Vegetation %, and Age 65+</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html,body,#map{height:100%;margin:0}
    .legend, .metric, .title, .search {
      background:#fff;padding:8px 10px;border-radius:6px;
      box-shadow:0 1px 4px rgba(0,0,0,.1);font:14px/1.2 system-ui, sans-serif
    }
    .legend i{display:inline-block;width:12px;height:12px;margin-right:6px;vertical-align:middle}
    .title  {position:absolute;left:50%;top:10px;transform:translateX(-50%);z-index:1000;font-weight:600}
    .metric {position:absolute;right:10px;top:10px;z-index:1000}
    .legend {position:absolute;left:10px;bottom:10px;z-index:1000}
    .search {position:absolute;right:10px;top:72px;z-index:1000;width:280px}
    .search input{width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px}
    .info-popup table{border-collapse:collapse;font:14px/1.2 system-ui, sans-serif}
    .info-popup td{padding:2px 6px;border-bottom:1px solid #eee}
    .info-popup td:first-child{font-weight:600;color:#555}
    /* print button style (top-left) from easyPrint is fine; we just lift it slightly */
    .leaflet-control-easyPrint {margin-top:10px}
  </style>
</head>
<body>
<div id="map"></div>

<!-- UI overlays -->
<div class="title">Melbourne LGAs — UHI, Vegetation %, and Age 65+</div>
<div class="metric">
  <label><strong>Metric</strong></label><br>
  <select id="metricSel">
    <option value="heat">Heat (UHI mean)</option>
    <option value="veg">Vegetation %</option>
    <option value="age">Age 65+ (count)</option>
  </select>
</div>
<div class="search">
  <label><strong>Find LGA</strong></label>
  <input id="searchBox" type="text" placeholder="Type LGA name and press Enter" />
</div>
<div id="legend" class="legend"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Save to PNG -->
<script src="https://unpkg.com/leaflet-easyprint@2.1.9/dist/bundle.min.js"></script>

<script>
  // ---- Map ----
  const map = L.map('map').setView([-37.8, 144.9], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { attribution:'© OpenStreetMap contributors' }).addTo(map);

  // Save PNG button
  L.easyPrint({
    title: 'Save PNG',
    position: 'topleft',
    sizeModes: ['Current','A4Landscape','A4Portrait'],
    exportOnly: true,
    hideControlContainer: false
  }).addTo(map);

  // ---- Metrics (fields, breaks, colors, formatting) ----
  const metrics = {
    heat: { field:'uhi18_m_mean', title:'Heat (UHI mean)',
      breaks:[7.5, 8.2, 8.9, 9.6],
      colors:['#ffffcc','#ffe082','#fdae61','#f46d43','#d73027'],
      fmt:v=>v==null?'-':Number(v).toFixed(2)
    },
    veg:  { field:'peranyveg_mean', title:'Vegetation %',
      breaks:[10, 20, 30, 40],
      colors:['#f7fcf5','#c7e9c0','#74c476','#238b45','#00441b'],
      fmt:v=>v==null?'-':Number(v).toFixed(2)
    },
    age:  { field:'persons_65plus', title:'Age 65+ (count)',
      breaks:[5000, 10000, 15000, 20000],
      colors:['#f2f0f7','#cbc9e2','#9e9ac8','#756bb1','#54278f'],
      fmt:v=>v==null?'-':v
    }
  };
  let current = 'heat';

  // ---- Helpers ----
  function colorFor(v, brks, colors){
    if (v==null || isNaN(v)) return '#cccccc';
    for(let i=0;i<brks.length;i++){
      if(v<=brks[i]) return colors[i];
    }
    return colors[colors.length-1];
  }

  function popupHtml(p){
    return `
      <div class="info-popup">
        <table>
          <tr><td>LGA</td><td>${p.lga_name ?? '-'}</td></tr>
          <tr><td>UHI mean</td><td>${metrics.heat.fmt(p.uhi18_m_mean)}</td></tr>
          <tr><td>Vegetation %</td><td>${metrics.veg.fmt(p.peranyveg_mean)}</td></tr>
          <tr><td>65+ (count)</td><td>${metrics.age.fmt(p.persons_65plus)}</td></tr>
        </table>
      </div>`;
  }

  function updateLegend(){
    const m = metrics[current];
    const d = document.getElementById('legend');
    const labels = [];
    let prev = -Infinity;
    for(let i=0;i<m.breaks.length;i++){
      const to = m.breaks[i];
      labels.push(`<div><i style="background:${m.colors[i]}"></i>${prev===-Infinity?'≤ ':''}${to}</div>`);
      prev = to;
    }
    labels.push(`<div><i style="background:${m.colors[m.colors.length-1]}"></i>&gt; ${m.breaks[m.breaks.length-1]}</div>`);
    d.innerHTML = `<strong>${m.title}</strong><br>${labels.join('')}`;
  }

  // ---- Data layer ----
  let geojson = null;
  let geoLayer = null;
  let highlight;     // temporary highlight for search

  function addLayer(){
    if (geoLayer) { map.removeLayer(geoLayer); geoLayer = null; }
    geoLayer = L.geoJSON(geojson, {
      style: feat => {
        const m = metrics[current];
        const v = feat.properties[m.field];
        return { color:'#666', weight:0.6, fillOpacity:0.85,
                 fillColor: colorFor(v, m.breaks, m.colors) };
      },
      onEachFeature: (feat, layer) => {
        layer.on('click', () => layer.bindPopup(popupHtml(feat.properties)).openPopup());
      }
    }).addTo(map);
  }

  function restyle(){
    if (!geoLayer) return;
    const m = metrics[current];
    geoLayer.setStyle(feat => {
      const v = feat.properties[m.field];
      return { fillColor: colorFor(v, m.breaks, m.colors) };
    });
  }

  // ---- Load GeoJSON (from repo root) ----
  fetch('lga_uhi_app.geojson?v=10', { cache:'no-store' })
    .then(r => {
      if (!r.ok) throw new Error(`GeoJSON HTTP ${r.status}`);
      return r.json();
    })
    .then(data => {
      if (!data || data.type !== 'FeatureCollection') throw new Error('Invalid GeoJSON');
      geojson = data;
      addLayer();
      updateLegend();
      try { map.fitBounds(L.geoJSON(geojson).getBounds()); } catch(_) {}
    })
    .catch(err => {
      console.error('Failed to load GeoJSON:', err);
      alert('Could not load GeoJSON. Make sure lga_uhi_app.geojson is in the repo root.');
      // Fallback test polygon so UI still shows something
      geojson = {"type":"FeatureCollection","features":[{
        "type":"Feature",
        "properties":{"lga_name":"TEST CBD","uhi18_m_mean":8.7,"peranyveg_mean":22.5,"persons_65plus":1234},
        "geometry":{"type":"Polygon","coordinates":[[[144.952,-37.821],[144.986,-37.821],[144.986,-37.805],[144.952,-37.805],[144.952,-37.821]]]}}
      ]};
      addLayer(); updateLegend();
      try { map.fitBounds(L.geoJSON(geojson).getBounds()); } catch(_) {}
    });

  // ---- Metric dropdown handler ----
  document.getElementById('metricSel').addEventListener('change', e => {
    current = e.target.value;
    restyle();
    updateLegend();
  });

  // ---- Search (zoom to LGA by name) ----
  const searchBox = document.getElementById('searchBox');
  searchBox.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter') return;
    const q = searchBox.value.trim().toLowerCase();
    if (!q || !geoLayer) return;

    let matchLayer = null;
    geoLayer.eachLayer(l => {
      const name = (l.feature?.properties?.lga_name || '').toLowerCase();
      if (!matchLayer && name.includes(q)) matchLayer = l;
    });

    if (!matchLayer) { alert('No matching LGA'); return; }

    // Zoom to and highlight the match briefly
    map.fitBounds(matchLayer.getBounds(), { maxZoom: 11 });
    if (highlight) { map.removeLayer(highlight); }
    highlight = L.geoJSON(matchLayer.feature, {
      style: { color:'#000', weight:3, fillOpacity:0 }
    }).addTo(map);
    setTimeout(() => { if(highlight){ map.removeLayer(highlight); highlight=null; }}, 2000);
    matchLayer.bindPopup(popupHtml(matchLayer.feature.properties)).openPopup();
  });
</script>
  
<iframe
  src="https://harveynye.github.io/melbourne_uhi_app/"
  width="100%"
  height="640"
  style="border:0"
  loading="eager"
  allowfullscreen>
</iframe>
  
<!-- License / attribution -->
<p style="position:absolute;left:8px;bottom:6px;background:#fff7;padding:4px 8px;border-radius:4px;">
  <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="license noopener">
    <img src="https://licensebuttons.net/l/by/4.0/88x31.png" alt="CC BY 4.0" style="vertical-align:middle">
  </a>
  <span style="margin-left:8px;">This Cloud-based Open-source GIS Application is developed by <a href="#" target="_blank" rel="noopener">Your Name</a> — CC BY 4.0</span>
</p>
</body>
</html>
